<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å¿ƒæƒ…æ—¥è®° - äº‘ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-100 to-blue-100 min-h-screen p-4">
    <div class="max-w-md mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6 mt-4">æˆ‘çš„å¿ƒæƒ…æ—¥è®°</h1>
        
        <!-- æˆ¿é—´å·è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">æˆ¿é—´å·</label>
                <div class="flex gap-2">
                    <input type="text" id="roomId" placeholder="è¾“å…¥æˆ¿é—´å·ï¼ˆå¦‚ï¼š520ï¼‰" 
                        class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button onclick="enterRoom()" 
                        class="bg-purple-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-600 transition duration-200">
                        è¿›å…¥
                    </button>
                </div>
                <p class="text-gray-500 text-sm mt-2">ğŸ’¡ è¾“å…¥ç›¸åŒæˆ¿é—´å·çš„äººå¯ä»¥çœ‹åˆ°ç›¸åŒçš„æ—¥è®°</p>
            </div>
        </div>

        <!-- æ—¥è®°è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">é€‰æ‹©å¿ƒæƒ…</label>
                <select id="mood" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="å¼€å¿ƒ ğŸ˜Š">å¼€å¿ƒ ğŸ˜Š</option>
                    <option value="å¹³é™ ğŸ˜">å¹³é™ ğŸ˜</option>
                    <option value="éš¾è¿‡ ğŸ˜¢">éš¾è¿‡ ğŸ˜¢</option>
                    <option value="ç”Ÿæ°” ğŸ˜ ">ç”Ÿæ°” ğŸ˜ </option>
                    <option value="å…´å¥‹ ğŸ¤©">å…´å¥‹ ğŸ¤©</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">æ—¥è®°å†…å®¹</label>
                <textarea id="content" rows="4" placeholder="å†™ä¸‹ä»Šå¤©çš„å¿ƒæƒ…..." 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"></textarea>
            </div>
            
            <button onclick="saveDiary()" id="saveBtn"
                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:from-purple-600 hover:to-pink-600 transition duration-200">
                ä¿å­˜æ—¥è®°
            </button>
        </div>

        <!-- çŠ¶æ€æç¤º -->
        <div id="status" class="hidden rounded-lg p-4 mb-4 text-center"></div>

        <!-- å†å²è®°å½• -->
        <h2 class="text-xl font-bold text-gray-800 mb-4">å†å²è®°å½•</h2>
        <div id="diaryList" class="space-y-3">
            <p class="text-gray-500 text-center py-4">è¯·è¾“å…¥æˆ¿é—´å·è¿›å…¥æˆ¿é—´</p>
        </div>
    </div>

    <script>
        // ========================================
        // ä¿®æ­£ï¼šå»æ‰ URL æœ«å°¾çš„ç©ºæ ¼ï¼
        // ========================================
        const SUPABASE_URL = 'https://salkxkyvjdcdyzonouhn.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_aMqSrbbQjiJlM-A2dRsO-w_TRCozumi';
        
        console.log('æ­£åœ¨è¿æ¥ Supabase...', SUPABASE_URL);
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('âœ… Supabase åˆå§‹åŒ–æˆåŠŸ');
        } catch (err) {
            console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', err);
            alert('è¿æ¥å¤±è´¥ï¼š' + err.message);
        }
        
        const TABLE_NAME = 'diaries';
        let currentRoomId = '';

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `rounded-lg p-4 mb-4 text-center ${isError ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            statusDiv.classList.remove('hidden');
            console.log(isError ? 'âŒ ' : 'âœ… ', message);
        }

        // è¿›å…¥æˆ¿é—´
        async function enterRoom() {
            const roomId = document.getElementById('roomId').value.trim();
            
            if (!roomId) {
                alert('è¯·è¾“å…¥æˆ¿é—´å·ï¼');
                return;
            }
            
            currentRoomId = roomId;
            localStorage.setItem('lastRoomId', roomId);
            showStatus(`æ­£åœ¨è¿›å…¥æˆ¿é—´ ${roomId}...`);
            
            await loadDiaries();
        }

        // è¯»å–æ—¥è®°
        async function loadDiaries() {
            if (!currentRoomId) return;
            
            try {
                console.log('æ­£åœ¨æŸ¥è¯¢æˆ¿é—´:', currentRoomId);
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    .eq('room_id', currentRoomId)
                    .order('created_at', { ascending: false });
                
                document.getElementById('status').classList.add('hidden');
                
                if (error) {
                    console.error('æŸ¥è¯¢é”™è¯¯:', error);
                    showStatus('è¯»å–å¤±è´¥ï¼š' + error.message, true);
                    return;
                }
                
                console.log('æŸ¥è¯¢æˆåŠŸï¼Œæ•°æ®:', data);
                displayDiaries(data || []);
                
            } catch (err) {
                console.error('åŠ è½½å¼‚å¸¸:', err);
                showStatus('åŠ è½½å¼‚å¸¸ï¼š' + err.message, true);
            }
        }

        // æ˜¾ç¤ºåˆ—è¡¨
        function displayDiaries(diaries) {
            const listDiv = document.getElementById('diaryList');
            
            if (!diaries || diaries.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">æˆ¿é—´é‡Œè¿˜æ²¡æœ‰æ—¥è®°ï¼Œå†™ç¬¬ä¸€ç¯‡å§ï¼</p>';
                return;
            }
            
            listDiv.innerHTML = diaries.map(diary => {
                const time = new Date(diary.created_at).toLocaleString('zh-CN');
                const emoji = diary.mood ? diary.mood.split(' ')[1] : 'ğŸ“';
                
                return `
                    <div class="bg-white rounded-xl shadow p-4 relative group">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-2xl">${emoji}</span>
                            <button onclick="deleteDiary(${diary.id})" 
                                class="text-red-500 hover:text-red-700 text-sm opacity-0 group-hover:opacity-100 transition">
                                åˆ é™¤
                            </button>
                        </div>
                        <p class="text-gray-800 mb-2">${diary.content || ''}</p>
                        <p class="text-gray-400 text-sm">${time}</p>
                    </div>
                `;
            }).join('');
        }

        // ä¿å­˜æ—¥è®°
        async function saveDiary() {
            if (!currentRoomId) {
                alert('è¯·å…ˆè¾“å…¥æˆ¿é—´å·å¹¶ç‚¹å‡»"è¿›å…¥"ï¼');
                return;
            }
            
            const mood = document.getElementById('mood').value;
            const content = document.getElementById('content').value;
            
            if (!content.trim()) {
                alert('è¯·å†™ç‚¹ä»€ä¹ˆå§ï¼');
                return;
            }
            
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            showStatus('æ­£åœ¨ä¿å­˜...');
            
            try {
                console.log('æ­£åœ¨ä¿å­˜åˆ°æˆ¿é—´:', currentRoomId);
                const diaryData = {
                    room_id: currentRoomId,
                    mood: mood,
                    content: content,
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .insert([diaryData])
                    .select();
                
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜æ—¥è®°';
                
                if (error) {
                    console.error('ä¿å­˜é”™è¯¯:', error);
                    showStatus('ä¿å­˜å¤±è´¥ï¼š' + error.message, true);
                    return;
                }
                
                console.log('ä¿å­˜æˆåŠŸ:', data);
                document.getElementById('content').value = '';
                showStatus('ä¿å­˜æˆåŠŸï¼');
                await loadDiaries();
                
                setTimeout(() => {
                    document.getElementById('status').classList.add('hidden');
                }, 2000);
                
            } catch (err) {
                console.error('ä¿å­˜å¼‚å¸¸:', err);
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜æ—¥è®°';
                showStatus('ä¿å­˜å¼‚å¸¸ï¼š' + err.message, true);
            }
        }

        // åˆ é™¤æ—¥è®°
        async function deleteDiary(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ')) return;
            
            showStatus('æ­£åœ¨åˆ é™¤...');
            
            try {
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    showStatus('åˆ é™¤å¤±è´¥ï¼š' + error.message, true);
                    return;
                }
                
                showStatus('åˆ é™¤æˆåŠŸï¼');
                await loadDiaries();
                
            } catch (err) {
                showStatus('åˆ é™¤å¼‚å¸¸ï¼š' + err.message, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤æˆ¿é—´å·
        window.onload = function() {
            const savedRoomId = localStorage.getItem('lastRoomId');
            if (savedRoomId) {
                document.getElementById('roomId').value = savedRoomId;
            }
        };
    </script>
</body>
</html>