<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å¿ƒæƒ…æ—¥è®° - äº‘ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-100 to-blue-100 min-h-screen p-4">
    <div class="max-w-md mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6 mt-4">æˆ‘çš„å¿ƒæƒ…æ—¥è®°</h1>
        
        <!-- æˆ¿é—´å·è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">æˆ¿é—´å·</label>
                <div class="flex gap-2">
                    <input type="text" id="roomId" placeholder="è¾“å…¥æˆ¿é—´å·ï¼ˆå¦‚ï¼š520ï¼‰" 
                        class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button onclick="loadDiaries()" 
                        class="bg-purple-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-600 transition duration-200">
                        è¿›å…¥
                    </button>
                </div>
                <p class="text-gray-500 text-sm mt-2">ğŸ’¡ è¾“å…¥ç›¸åŒæˆ¿é—´å·çš„äººå¯ä»¥çœ‹åˆ°ç›¸åŒçš„æ—¥è®°</p>
            </div>
        </div>

        <!-- æ—¥è®°è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">é€‰æ‹©å¿ƒæƒ…</label>
                <select id="mood" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="å¼€å¿ƒ ğŸ˜Š">å¼€å¿ƒ ğŸ˜Š</option>
                    <option value="å¹³é™ ğŸ˜">å¹³é™ ğŸ˜</option>
                    <option value="éš¾è¿‡ ğŸ˜¢">éš¾è¿‡ ğŸ˜¢</option>
                    <option value="ç”Ÿæ°” ğŸ˜ ">ç”Ÿæ°” ğŸ˜ </option>
                    <option value="å…´å¥‹ ğŸ¤©">å…´å¥‹ ğŸ¤©</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">æ—¥è®°å†…å®¹</label>
                <textarea id="content" rows="4" placeholder="å†™ä¸‹ä»Šå¤©çš„å¿ƒæƒ…..." 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"></textarea>
            </div>
            
            <button onclick="saveDiary()" id="saveBtn"
                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:from-purple-600 hover:to-pink-600 transition duration-200">
                ä¿å­˜æ—¥è®°
            </button>
        </div>

        <!-- åŠ è½½çŠ¶æ€æç¤º -->
        <div id="loading" class="hidden bg-blue-100 text-blue-800 rounded-lg p-4 mb-4 text-center">
            <span class="animate-pulse">â³ åŠ è½½ä¸­...</span>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="error" class="hidden bg-red-100 text-red-800 rounded-lg p-4 mb-4 text-center">
            <span>âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</span>
        </div>

        <!-- å†å²è®°å½• -->
        <h2 class="text-xl font-bold text-gray-800 mb-4">å†å²è®°å½•</h2>
        <div id="diaryList" class="space-y-3">
            <p class="text-gray-500 text-center py-4">è¯·è¾“å…¥æˆ¿é—´å·è¿›å…¥æˆ¿é—´</p>
        </div>
    </div>

    <script>
        // ========================================
        // Supabase é…ç½®å’Œåˆå§‹åŒ–
        // ========================================
        
        // Supabase é¡¹ç›®é…ç½®ä¿¡æ¯
        const SUPABASE_URL = 'https://salkxkyvjdcdyzonouhn.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_aMqSrbbQjiJlM-A2dRsO-w_TRCozumi';
        
        // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // æ•°æ®è¡¨åç§°
        const TABLE_NAME = 'diaries';
        
        // å½“å‰æˆ¿é—´å·
        let currentRoomId = '';

        // ========================================
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        // ========================================
        window.onload = function() {
            // ä» localStorage æ¢å¤ä¸Šæ¬¡ä½¿ç”¨çš„æˆ¿é—´å·
            const savedRoomId = localStorage.getItem('lastRoomId');
            if (savedRoomId) {
                document.getElementById('roomId').value = savedRoomId;
            }
        };

        // ========================================
        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        // ========================================
        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            if (show) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
            }
        }

        // ========================================
        // æ˜¾ç¤º/éšè—é”™è¯¯æç¤º
        // ========================================
        function showError(show, message = 'åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ') {
            const errorDiv = document.getElementById('error');
            if (show) {
                errorDiv.innerHTML = `<span>âŒ ${message}</span>`;
                errorDiv.classList.remove('hidden');
                // 3ç§’åè‡ªåŠ¨éšè—é”™è¯¯æç¤º
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 3000);
            } else {
                errorDiv.classList.add('hidden');
            }
        }

        // ========================================
        // ä» Supabase è¯»å–æ—¥è®°
        // ========================================
        async function loadDiaries() {
            const roomId = document.getElementById('roomId').value.trim();
            
            // éªŒè¯æˆ¿é—´å·
            if (!roomId) {
                alert('è¯·è¾“å…¥æˆ¿é—´å·ï¼');
                return;
            }
            
            // ä¿å­˜å½“å‰æˆ¿é—´å·
            currentRoomId = roomId;
            localStorage.setItem('lastRoomId', roomId);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading(true);
            showError(false);
            
            try {
                // ä» Supabase æŸ¥è¯¢è¯¥æˆ¿é—´å·çš„æ‰€æœ‰æ—¥è®°ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    .eq('room_id', roomId)
                    .order('created_at', { ascending: false });
                
                // éšè—åŠ è½½çŠ¶æ€
                showLoading(false);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                if (error) {
                    console.error('è¯»å–å¤±è´¥:', error);
                    showError(true);
                    return;
                }
                
                // æ˜¾ç¤ºæ—¥è®°åˆ—è¡¨
                displayDiaries(data || []);
                
            } catch (err) {
                // æ•è·ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸
                console.error('åŠ è½½æ—¥è®°å‡ºé”™:', err);
                showLoading(false);
                showError(true);
            }
        }

        // ========================================
        // æ˜¾ç¤ºæ—¥è®°åˆ—è¡¨
        // ========================================
        function displayDiaries(diaries) {
            const listDiv = document.getElementById('diaryList');
            
            // å¦‚æœæ²¡æœ‰æ—¥è®°ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (diaries.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå†™ç¬¬ä¸€ç¯‡å§ï¼</p>';
                return;
            }
            
            // éå†æ—¥è®°æ•°ç»„ï¼Œç”Ÿæˆ HTML
            listDiv.innerHTML = diaries.map(diary => {
                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                const time = new Date(diary.created_at).toLocaleString('zh-CN');
                // æå–è¡¨æƒ…ç¬¦å·
                const emoji = diary.mood.split(' ')[1] || diary.mood;
                
                return `
                    <div class="bg-white rounded-xl shadow p-4 relative group">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-2xl">${emoji}</span>
                            <button onclick="deleteDiary('${diary.id}')" 
                                class="text-red-500 hover:text-red-700 text-sm opacity-0 group-hover:opacity-100 transition">
                                åˆ é™¤
                            </button>
                        </div>
                        <p class="text-gray-800 mb-2">${diary.content}</p>
                        <p class="text-gray-400 text-sm">${time}</p>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // ä¿å­˜æ—¥è®°åˆ° Supabase
        // ========================================
        async function saveDiary() {
            // éªŒè¯æˆ¿é—´å·
            if (!currentRoomId) {
                alert('è¯·å…ˆè¾“å…¥æˆ¿é—´å·å¹¶ç‚¹å‡»"è¿›å…¥"æŒ‰é’®ï¼');
                return;
            }
            
            const mood = document.getElementById('mood').value;
            const content = document.getElementById('content').value;
            
            // éªŒè¯å†…å®¹ä¸ä¸ºç©º
            if (!content.trim()) {
                alert('è¯·å†™ç‚¹ä»€ä¹ˆå§ï¼');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading(true);
            showError(false);
            
            // ç¦ç”¨ä¿å­˜æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            
            try {
                // æ„å»ºè¦æ’å…¥çš„æ•°æ®å¯¹è±¡
                const diaryData = {
                    room_id: currentRoomId,
                    mood: mood,
                    content: content,
                    created_at: new Date().toISOString()
                };
                
                // å‘ Supabase æ’å…¥æ–°æ—¥è®°
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .insert([diaryData])
                    .select();
                
                // éšè—åŠ è½½çŠ¶æ€
                showLoading(false);
                
                // æ¢å¤ä¿å­˜æŒ‰é’®
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜æ—¥è®°';
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                if (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    showError(true);
                    return;
                }
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('content').value = '';
                
                // åˆ·æ–°æ—¥è®°åˆ—è¡¨
                await loadDiaries();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                alert('ä¿å­˜æˆåŠŸï¼');
                
            } catch (err) {
                // æ•è·ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸
                console.error('ä¿å­˜æ—¥è®°å‡ºé”™:', err);
                showLoading(false);
                saveBtn.disabled = false;
                saveBtn.textContent = 'ä¿å­˜æ—¥è®°';
                showError(true);
            }
        }

        // ========================================
        // ä» Supabase åˆ é™¤æ—¥è®°
        // ========================================
        async function deleteDiary(id) {
            // ç¡®è®¤åˆ é™¤æ“ä½œ
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ')) return;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading(true);
            showError(false);
            
            try {
                // ä» Supabase åˆ é™¤æŒ‡å®š ID çš„æ—¥è®°
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .delete()
                    .eq('id', id);
                
                // éšè—åŠ è½½çŠ¶æ€
                showLoading(false);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                if (error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    showError(true);
                    return;
                }
                
                // åˆ·æ–°æ—¥è®°åˆ—è¡¨
                await loadDiaries();
                
            } catch (err) {
                // æ•è·ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸
                console.error('åˆ é™¤æ—¥è®°å‡ºé”™:', err);
                showLoading(false);
                showError(true);
            }
        }
    </script>
</body>
</html>