<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å¿ƒæƒ…æ—¥è®° - ç§äººç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // ========================================
        // é…ç½®ï¼ˆç”¨ä½ çš„çœŸå®ä¿¡æ¯æ›¿æ¢ï¼‰
        // ========================================
        const SUPABASE_URL = 'https://salkxkyvjdcdyzonouhn.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_aMqSrbbQjiJlM-A2dRsO-w_TRCozumi';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ========================================
        // å…¨å±€çŠ¶æ€
        // ========================================
        let currentUser = null;
        
        // ========================================
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        // ========================================
        window.onload = async function() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                showDiaryView();
                loadDiaries();
            } else {
                showAuthView();
            }
        };
        
        // ========================================
        // ç•Œé¢åˆ‡æ¢
        // ========================================
        function showAuthView() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('diarySection').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }
        
        function showDiaryView() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('diarySection').classList.remove('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
        }
        
        // ========================================
        // æ³¨å†ŒåŠŸèƒ½
        // ========================================
        window.register = async function() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                alert('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                return;
            }
            
            if (password.length < 6) {
                alert('å¯†ç è‡³å°‘6ä½');
                return;
            }
            
            showStatus('æ³¨å†Œä¸­...');
            
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password
            });
            
            if (error) {
                showStatus('æ³¨å†Œå¤±è´¥ï¼š' + error.message, true);
                return;
            }
            
            showStatus('æ³¨å†ŒæˆåŠŸï¼å·²è‡ªåŠ¨ç™»å½•');
            currentUser = data.user;
            showDiaryView();
            loadDiaries();
        };
        
        // ========================================
        // ç™»å½•åŠŸèƒ½
        // ========================================
        window.login = async function() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                alert('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                return;
            }
            
            showStatus('ç™»å½•ä¸­...');
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                showStatus('ç™»å½•å¤±è´¥ï¼š' + error.message, true);
                return;
            }
            
            showStatus('ç™»å½•æˆåŠŸï¼');
            currentUser = data.user;
            showDiaryView();
            loadDiaries();
        };
        
        // ========================================
        // é€€å‡ºç™»å½•
        // ========================================
        window.logout = async function() {
            await supabase.auth.signOut();
            currentUser = null;
            showAuthView();
            showStatus('å·²é€€å‡ºç™»å½•');
        };
        
        // ========================================
        // è¯»å–æ—¥è®°ï¼ˆåªè¯»è‡ªå·±çš„ï¼‰
        // ========================================
        async function loadDiaries() {
            if (!currentUser) return;
            
            showStatus('åŠ è½½ä¸­...');
            
            const { data, error } = await supabase
                .from('diaries')
                .select('*')
                .eq('user_id', currentUser.id)  // å…³é”®ï¼šåªæŸ¥è‡ªå·±çš„
                .order('created_at', { ascending: false });
            
            document.getElementById('status').classList.add('hidden');
            
            if (error) {
                showStatus('åŠ è½½å¤±è´¥ï¼š' + error.message, true);
                return;
            }
            
            displayDiaries(data || []);
        }
        
        // ========================================
        // æ˜¾ç¤ºæ—¥è®°åˆ—è¡¨
        // ========================================
        function displayDiaries(diaries) {
            const listDiv = document.getElementById('diaryList');
            
            if (diaries.length === 0) {
                listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">è¿˜æ²¡æœ‰æ—¥è®°ï¼Œå†™ç¬¬ä¸€ç¯‡å§ï¼</p>';
                return;
            }
            
            listDiv.innerHTML = diaries.map(diary => {
                const time = new Date(diary.created_at).toLocaleString('zh-CN');
                const emoji = diary.mood ? diary.mood.split(' ')[1] : 'ğŸ“';
                
                return `
                    <div class="bg-white rounded-xl shadow p-4 relative group">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-2xl">${emoji}</span>
                            <span class="text-gray-400 text-xs">${time}</span>
                        </div>
                        <p class="text-gray-800 mb-2">${diary.content || ''}</p>
                        <button onclick="deleteDiary(${diary.id})" 
                            class="text-red-500 hover:text-red-700 text-sm mt-2">
                            åˆ é™¤
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // ========================================
        // ä¿å­˜æ—¥è®°ï¼ˆå¸¦ä¸Š user_idï¼‰
        // ========================================
        window.saveDiary = async function() {
            const mood = document.getElementById('mood').value;
            const content = document.getElementById('content').value;
            
            if (!content.trim()) {
                alert('è¯·å†™ç‚¹ä»€ä¹ˆå§ï¼');
                return;
            }
            
            showStatus('ä¿å­˜ä¸­...');
            
            const { data, error } = await supabase
                .from('diaries')
                .insert([{
                    user_id: currentUser.id,  // å…³é”®ï¼šæ ‡è®°ä¸»äºº
                    mood: mood,
                    content: content,
                    created_at: new Date().toISOString()
                }]);
            
            if (error) {
                showStatus('ä¿å­˜å¤±è´¥ï¼š' + error.message, true);
                return;
            }
            
            document.getElementById('content').value = '';
            showStatus('ä¿å­˜æˆåŠŸï¼');
            loadDiaries();
            
            setTimeout(() => {
                document.getElementById('status').classList.add('hidden');
            }, 2000);
        };
        
        // ========================================
        // åˆ é™¤æ—¥è®°
        // ========================================
        window.deleteDiary = async function(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ')) return;
            
            const { error } = await supabase
                .from('diaries')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id);  // ç¡®ä¿åªèƒ½åˆ è‡ªå·±çš„
            
            if (error) {
                showStatus('åˆ é™¤å¤±è´¥ï¼š' + error.message, true);
                return;
            }
            
            loadDiaries();
        };
        
        // ========================================
        // çŠ¶æ€æç¤º
        // ========================================
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `rounded-lg p-4 mb-4 text-center ${isError ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}`;
            statusDiv.classList.remove('hidden');
        }
    </script>
</head>
<body class="bg-gradient-to-br from-purple-100 to-blue-100 min-h-screen p-4">
    
    <!-- çŠ¶æ€æç¤ºæ¡ -->
    <div id="status" class="hidden max-w-md mx-auto mt-4"></div>
    
    <!-- ========== ç™»å½•/æ³¨å†ŒåŒºåŸŸ ========== -->
    <div id="authSection" class="max-w-md mx-auto pt-10">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">æˆ‘çš„å¿ƒæƒ…æ—¥è®°</h1>
        <p class="text-center text-gray-600 mb-8">ç§äººäº‘ç«¯æ—¥è®°æœ¬</p>
        
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">é‚®ç®±</label>
                <input type="email" id="authEmail" placeholder="your@email.com" 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            
            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-2">å¯†ç </label>
                <input type="password" id="authPassword" placeholder="è‡³å°‘6ä½å¯†ç " 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            
            <div class="flex gap-3">
                <button onclick="login()" 
                    class="flex-1 bg-purple-500 text-white font-bold py-3 rounded-lg hover:bg-purple-600 transition">
                    ç™»å½•
                </button>
                <button onclick="register()" 
                    class="flex-1 bg-pink-500 text-white font-bold py-3 rounded-lg hover:bg-pink-600 transition">
                    æ³¨å†Œ
                </button>
            </div>
            
            <p class="text-gray-500 text-sm mt-4 text-center">
                ğŸ’¡ é¦–æ¬¡ä½¿ç”¨è¯·ç‚¹å‡»"æ³¨å†Œ"<br>
                å»ºè®®ç”¨çœŸå®é‚®ç®±ï¼Œæ–¹ä¾¿æ‰¾å›å¯†ç 
            </p>
        </div>
    </div>
    
    <!-- ========== æ—¥è®°åŒºåŸŸï¼ˆç™»å½•åæ˜¾ç¤ºï¼‰ ========== -->
    <div id="diarySection" class="hidden max-w-md mx-auto">
        <!-- é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯ -->
        <div id="userInfo" class="flex justify-between items-center mb-6 mt-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">æˆ‘çš„å¿ƒæƒ…æ—¥è®°</h1>
                <p class="text-sm text-gray-600" id="userEmail">user@email.com</p>
            </div>
            <button onclick="logout()" class="text-gray-500 hover:text-gray-700 text-sm underline">
                é€€å‡ºç™»å½•
            </button>
        </div>
        
        <!-- å†™æ—¥è®° -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">é€‰æ‹©å¿ƒæƒ…</label>
                <select id="mood" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="å¼€å¿ƒ ğŸ˜Š">å¼€å¿ƒ ğŸ˜Š</option>
                    <option value="å¹³é™ ğŸ˜">å¹³é™ ğŸ˜</option>
                    <option value="éš¾è¿‡ ğŸ˜¢">éš¾è¿‡ ğŸ˜¢</option>
                    <option value="ç”Ÿæ°” ğŸ˜ ">ç”Ÿæ°” ğŸ˜ </option>
                    <option value="å…´å¥‹ ğŸ¤©">å…´å¥‹ ğŸ¤©</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-medium mb-2">æ—¥è®°å†…å®¹</label>
                <textarea id="content" rows="4" placeholder="å†™ä¸‹ä»Šå¤©çš„å¿ƒæƒ…..." 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"></textarea>
            </div>
            
            <button onclick="saveDiary()" 
                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-3 rounded-lg hover:from-purple-600 hover:to-pink-600 transition">
                ä¿å­˜æ—¥è®°
            </button>
        </div>
        
        <!-- å†å²è®°å½• -->
        <h2 class="text-xl font-bold text-gray-800 mb-4">å†å²è®°å½•</h2>
        <div id="diaryList" class="space-y-3">
            <p class="text-gray-500 text-center py-4">åŠ è½½ä¸­...</p>
        </div>
    </div>
    
</body>
</html>